# GitHub Copilot Coding Agent Setup Steps
# This file configures the environment for Copilot to build, test, and validate changes
# See: https://docs.github.com/en/copilot/customizing-copilot/adding-custom-instructions-for-github-copilot

# Install required tools and dependencies
setup:
  - name: Install .NET SDK
    run: |
      # .NET 10 is required for the API backend
      wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
      chmod +x dotnet-install.sh
      ./dotnet-install.sh --version latest --channel 10.0
      export PATH="$HOME/.dotnet:$PATH"
      dotnet --version

  - name: Install Node.js
    run: |
      # Node.js 22 is used for the React frontend
      curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
      sudo apt-get install -y nodejs
      node --version
      npm --version

  - name: Install Python
    run: |
      # Python 3.11+ is required for ingestion scripts
      sudo apt-get update
      sudo apt-get install -y python3.11 python3.11-venv python3-pip
      python3.11 --version

  - name: Start Docker services
    run: |
      # Start PostgreSQL, Redis, and Elasticsearch for integration tests
      docker compose up -d
      sleep 5
      docker compose ps

# Build commands for each component
build:
  - name: Build .NET API
    working-directory: .
    run: |
      dotnet restore parcferme.sln
      dotnet build parcferme.sln --no-restore --configuration Release

  - name: Build React Web App
    working-directory: src/web
    run: |
      npm ci
      npm run build

  - name: Install Python dependencies
    working-directory: src/python
    run: |
      python3.11 -m venv .venv
      .venv/bin/pip install --upgrade pip
      .venv/bin/pip install -e ".[dev]"

# Linting commands
lint:
  - name: Lint .NET code
    working-directory: .
    run: |
      dotnet format parcferme.sln --verify-no-changes --verbosity diagnostic

  - name: Lint React code
    working-directory: src/web
    run: |
      npm run lint

  - name: Lint Python code
    working-directory: src/python
    run: |
      pip install ruff
      ruff check .
      ruff format --check .

# Type checking commands
type-check:
  - name: Type check React code
    working-directory: src/web
    run: |
      npm run type-check

  - name: Type check Python code
    working-directory: src/python
    run: |
      .venv/bin/mypy ingestion/

# Test commands
test:
  - name: Test .NET API (unit tests)
    working-directory: .
    run: |
      dotnet test tests/api/ParcFerme.Api.Tests.csproj \
        --no-build \
        --configuration Release \
        --verbosity normal

  - name: Test .NET API (integration tests)
    working-directory: .
    environment:
      ConnectionStrings__DefaultConnection: "Host=localhost;Database=parcferme_test;Username=parcferme;Password=testpassword"
      ConnectionStrings__Redis: "localhost:6379"
    run: |
      dotnet test tests/api/ParcFerme.Api.Tests.csproj \
        --no-build \
        --configuration Release \
        --filter "Category=Integration" \
        --verbosity normal

  - name: Test React Web App
    working-directory: src/web
    run: |
      npm run test:run

  - name: Test Python ingestion
    working-directory: src/python
    run: |
      .venv/bin/pytest --verbose

# Quick validation commands (for fast feedback during development)
validate:
  - name: Quick checks
    run: |
      # Check for merge conflict markers
      if grep -rn "<<<<<<< " --include="*.ts" --include="*.tsx" --include="*.cs" --include="*.py" --include="*.json" .; then
        echo "❌ Merge conflict markers found!"
        exit 1
      fi
      
      # Verify solution file exists
      if [ ! -f parcferme.sln ]; then
        echo "❌ Solution file not found!"
        exit 1
      fi
      
      echo "✅ Quick validation passed"

  - name: Verify Python imports
    working-directory: src/python
    run: |
      .venv/bin/python -c "from ingestion import healthcheck"
      .venv/bin/python -c "from ingestion.clients import openf1"
      .venv/bin/python -c "from ingestion import config"
      echo "✅ Python imports verified"

# Database migration commands
database:
  - name: Apply database migrations
    working-directory: src/api
    run: |
      dotnet ef database update

# Development server commands (for manual testing)
dev:
  - name: Run API server
    working-directory: src/api
    run: |
      dotnet watch run

  - name: Run Web frontend
    working-directory: src/web
    run: |
      npm run dev

  - name: Run Python healthcheck
    working-directory: src/python
    run: |
      .venv/bin/python -m ingestion.healthcheck
